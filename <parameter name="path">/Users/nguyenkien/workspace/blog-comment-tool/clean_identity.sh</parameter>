<parameter name="content">#!/bin/bash
# üßπ Script x√≥a th√¥ng tin c√° nh√¢n kh·ªèi git history
# D√πng ƒë·ªÉ chu·∫©n b·ªã th∆∞∆°ng m·∫°i h√≥a

set -e

echo "=============================================="
echo "üßπ B·∫ÆT ƒê·∫¶U X√ìA TH√îNG TIN C√Å NH√ÇN"
echo "=============================================="

# Ki·ªÉm tra git-filter-repo
if ! command -v git-filter-repo &> /dev/null; then
    echo "‚ùå Ch∆∞a c√†i ƒë·∫∑t git-filter-repo"
    echo "   C√†i ƒë·∫∑t: pip install git-filter-repo"
    exit 1
fi

# B∆∞·ªõc 1: Backup
echo ""
echo "üì¶ B∆∞·ªõc 1: Backup repo..."
BACKUP_DIR="../blogcomment-backup-$(date +%Y%m%d-%H%M%S).git"
cp -r .git "$BACKUP_DIR"
echo "‚úÖ Backup saved to: $BACKUP_DIR"

# B∆∞·ªõc 2: H·ªèi th√¥ng tin m·ªõi
echo ""
echo "üìù B∆∞·ªõc 2: Nh·∫≠p th√¥ng tin m·ªõi cho commits"
read -p "Nh·∫≠p t√™n m·ªõi (Enter ƒë·ªÉ x√≥a ho√†n to√†n): " NEW_NAME
read -p "Nh·∫≠p email m·ªõi (Enter ƒë·ªÉ x√≥a ho√†n to√†n): " NEW_EMAIL
echo ""
read -p "Nh·∫≠p repo URL m·ªõi (v√≠ d·ª•: git@github.com:company/product.git): " NEW_REPO_URL

# B∆∞·ªõc 3: Rewrite history
echo ""
echo "üîÑ B∆∞·ªõc 3: Rewrite git history..."

if [ -z "$NEW_NAME" ] && [ -z "$NEW_EMAIL" ]; then
    echo "   X√≥a t·∫•t c·∫£ th√¥ng tin t√°c gi·∫£..."
    git filter-repo --name-callback 'return None' --email-callback 'return None' --force
else
    echo "   Thay th·∫ø b·∫±ng: $NEW_NAME <$NEW_EMAIL>"
    git filter-repo --name-callback "return '$NEW_NAME'" --email-callback "return '$NEW_EMAIL'" --force
fi

echo "‚úÖ Git history ƒë√£ ƒë∆∞·ª£c rewrite"

# B∆∞·ªõc 4: C·∫≠p nh·∫≠t remote URL
echo ""
echo "üîó B∆∞·ªõc 4: C·∫≠p nh·∫≠t remote URL..."
if [ -n "$NEW_REPO_URL" ]; then
    git remote set-url origin "$NEW_REPO_URL"
    echo "‚úÖ Remote updated to: $NEW_REPO_URL"
else
    echo "‚ö†Ô∏è  B·ªè qua c·∫≠p nh·∫≠t remote (ch∆∞a nh·∫≠p URL m·ªõi)"
fi

# B∆∞·ªõc 5: C·∫≠p nh·∫≠t deploy script
echo ""
echo "üìù B∆∞·ªõc 5: C·∫≠p nh·∫≠t deploy script..."
if [ -f "scripts/deploy_vps.sh" ] && [ -n "$NEW_REPO_URL" ]; then
    # Chuy·ªÉn ƒë·ªïi SSH URL sang HTTPS format cho deploy script
    DEPLOY_URL="$NEW_REPO_URL"
    if [[ "$DEPLOY_URL" == git@* ]]; then
        # git@github.com:user/repo.git -> https://github.com/user/repo.git
        DEPLOY_URL="https://github.com/${DEPLOY_URL#git@github.com:}"
    fi
    
    # Thay th·∫ø URL trong deploy script
    sed -i "s|https://github.com/kienntse25/blogcomment.git|$DEPLOY_URL|g" scripts/deploy_vps.sh
    echo "‚úÖ Deploy script updated to: $DEPLOY_URL"
fi

# B∆∞·ªõc 6: Ki·ªÉm tra k·∫øt qu·∫£
echo ""
echo "üîç B∆∞·ªõc 6: Ki·ªÉm tra k·∫øt qu·∫£..."
echo ""
echo "5 commits g·∫ßn nh·∫•t:"
git log --oneline -5
echo ""
echo "T√°c gi·∫£ trong commits g·∫ßn nh·∫•t:"
git log -1 --format='Author: %(authorname) <%(authoremail)>'
echo ""
echo "Remote URL:"
git remote get-url origin

# B∆∞·ªõc 7: H∆∞·ªõng d·∫´n push
echo ""
echo "=============================================="
echo "‚úÖ HO√ÄN TH√ÄNH T·∫†I LOCAL!"
echo "=============================================="
echo ""
echo "üìå C√°c b∆∞·ªõc ti·∫øp theo:"
echo ""
echo "1. Force push l√™n repo m·ªõi:"
echo "   git push origin main --force"
echo ""
echo "2. X√≥a repo c≈© tr√™n GitHub sau khi push th√†nh c√¥ng"
echo ""
echo "3. ƒê·ªÉ deploy l√™n VPS m·ªõi, ch·∫°y:"
echo "   REPO_URL=$NEW_REPO_URL bash scripts/deploy_vps.sh"
echo ""
echo "4. ƒê·ªÉ update VPS ƒë√£ deploy, ch·∫°y tr√™n VPS:"
echo "   bash scripts/update_vps.sh"
echo ""
echo "‚ö†Ô∏è L∆∞u √Ω:"
echo "   - Backup n·∫±m ·ªü: $BACKUP_DIR"
echo "   - Deploy script ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t v·ªõi URL m·ªõi"
echo ""
</parameter>
